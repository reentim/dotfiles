#!/usr/bin/env ruby
# watch.rb by Brett Terpstra, 2011 <http://brettterpstra.com>
# with credit to Carlo Zottmann <https://github.com/carlo/haml-sass-file-watcher>

require "rake"

trap("SIGINT") { exit }

FILETYPES = ['css', 'html', 'rb', 'erb', 'js', 'scss']

# recursive
def files
  @files ||= FILETYPES.map do |type|
    FileList[File.join(".", "**", "*.#{type}")].exclude(/node_modules/)
  end.flatten
end

abort "\nNo files found!" unless files.any?

def refresh_browser
  puts 'Refreshing...'
  apple_script
end

def apple_script
%x{osascript<<HEREDOC
  tell application "Google Chrome"
    set windowList to every window

    repeat with aWindow in windowList
      set tabList to every tab of aWindow

      repeat with atab in tabList
        tell atab to reload
      end repeat

    end repeat
  end tell
HEREDOC
}
end

def report_changes(changed_file)
  puts "Detected change in #{changed_file[0]}"
end

tick = 0
while true do
  tick += 1

  new_hash = files.collect { |f|
    [
      f,
      File.exists?(f) ? File.stat(f).mtime.to_i : nil
    ]
  }
  hash ||= new_hash
  diff_hash = new_hash - hash

  unless diff_hash.empty?
    hash = new_hash

    diff_hash.each do |df|
      report_changes(df)
    end

    refresh_browser
  end

  if tick >= 9
    tick = 0
    @files = nil
  end

  sleep 0.25
end
