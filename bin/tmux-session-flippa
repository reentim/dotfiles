#!/usr/bin/env bash

function flippa-tmux {
	tmux start-server

	tmux new-session -d -s php -n php
		tmux send-keys -t php:php "cd flippa/flippa && clear" C-m
		tmux send-keys -t php:php "git fetch && git status" C-m

	tmux new-session -d -s logs -n unicorn
			tmux send-keys -t logs:unicorn "cd ~/flippa/rails && clear" C-m
			tmux send-keys -t logs:unicorn "sleep 5 && bundle exec god -c config/god/all.rb && bundle exec god start web && sleep 5" C-m
			tmux send-keys -t logs:unicorn "tail -f /tmp/god/unicorn.log" C-m

		tmux new-window -t logs -n unicorn-no-http
			tmux send-keys -t logs:unicorn-no-http "sleep 15 && clear && tail -f /tmp/god/unicorn.log | grep -v '192.168.33.1'" C-m

		tmux new-window -t logs -n development
			tmux send-keys -t logs:development "cd ~/flippa/rails && sleep 5 && clear" C-m
			tmux send-keys -t logs:development "tail -f log/development.log" C-m

		tmux new-window -t logs -n test
			tmux send-keys -t logs:test "cd ~/flippa/rails" C-m
			tmux send-keys -t logs:test "clear && tail -f log/test.log" C-m

		tmux new-window -t logs -n sidekiq
			tmux send-keys -t logs:sidekiq "cd ~/flippa/rails && sleep 10 && clear" C-m
			tmux send-keys -t logs:sidekiq "bundle exec god start sidekiq && sleep 5 && tail -f /tmp/god/sidekiq.log" C-m

		tmux new-window -t logs -n commerce
			tmux send-keys -t logs:commerce "cd ~/flippa/commerce && clear" C-m
			tmux send-keys -t logs:commerce "./scripts/worker.php" C-m

		tmux new-window -t logs -n css
			tmux send-keys -t logs:css "cd ~/flippa/rails && clear" C-m
			tmux send-keys -t logs:css "bx rake css:watch" C-m

		tmux select-window -t :unicorn-no-http

	tmux new-session -d -s rails -n zeus
			if [ -f ~/flippa/rails/.zeus.sock ]; then
				rm ~/flippa/rails/.zeus.sock
			fi
			tmux send-keys -t rails:zeus "cd ~/flippa/rails && clear" C-m
			tmux send-keys -t rails:zeus "zeus start" C-m

		tmux new-window -t rails -n console
			tmux send-keys -t rails:console "cd ~/flippa/rails && sleep 5 && clear" C-m
			tmux send-keys -t rails:console "zeus console" C-m

		tmux new-window -t rails -n mysql
			tmux send-keys -t rails:mysql "cd ~/flippa/rails && clear" C-m
			tmux send-keys -t rails:mysql "mysql -u root flippa" C-m

		tmux new-window -t rails -n backend
			tmux send-keys -t rails:backend "cd ~/flippa/rails && clear" C-m
			tmux send-keys -t rails:backend "git fetch && git status" C-m

		tmux new-window -t rails -n frontend
			tmux send-keys -t rails:frontend "cd ~/flippa/rails && clear" C-m

		tmux new-window -t rails -n dotfiles
			tmux send-keys -t rails:dotfiles "cd ~/.dotfiles && git fetch && clear" C-m
			tmux send-keys -t rails:dotfiles "git status" C-m

		tmux select-window -t :backend
}

flippa-tmux
