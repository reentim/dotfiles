#!/usr/bin/env bash

# Customisation of standard behaviour
alias tree='tree -FC --dirsfirst'
alias rspec='rspec --color --tty --format documentation'
alias tmux='tmux -u' # force utf-8
alias grep='grep --color=auto'

ls_opt='--color=auto --group-directories-first --file-type --time-style=+"%Y-%m-%d %X"'
alias ls="ls $ls_opt"

if [[ $SYSTEM_TYPE == 'Darwin' ]]; then
	# use GNU ls if it's available
	if $(which gls > /dev/null); then
		alias ls="gls $ls_opt"
	else
		alias ls='ls -CFG'
	fi
fi

if [[ $SYSTEM_TYPE == 'Darwin' ]]; then
	if (which gstat > /dev/null); then
		alias stat="gstat"
	fi
fi

alias l='ls -lGgh' # list, omit group, omit owner, human readable sizes
alias ll='ls -la'  # list, show all files
alias la='ls -A'   # no list, show almost all

# Key-saving shortcuts
alias vi='vim'
alias diff='colordiff'
alias bx='bundle exec'
alias duh='du -csh'
alias sr='screen -r'
alias t='tmux'
alias ta='t a'
alias sshu='ssh -A -l ubuntu '

# Kind of new things
alias cdr='cd $(git rev-parse --show-cdup)'     # cd to git root

function ssh-flippa-worker {
  ssh -A -l ubuntu $(
    cd ~/flippa/rails && bx cap production |
    grep "^Found worker" |
    grep -oE "ec2.*$" |
    head -n 1
  )
}

# requires hub gem: https://github.com/github/hub
function pullreq {
  git push -u origin $(git rev-parse --abbrev-ref HEAD) &&
    hub pull-request
}

function stage {
  branch=$(git rev-parse --abbrev-ref HEAD)

  git co staging-$1 &&
    git fetch &&
    git reset --hard origin/staging-$1 &&
    git merge --no-ff origin/$branch &&
    git push &&
    git co $branch &&
    bundle exec cap staging$1 deploy
}

function delete-local-merged-branches {
  git branch --merged |
    grep -v "*" |
    grep -v master |
    xargs -n 1 git branch -d
}

function delete-remote-merged-branches {
  git branch -a --merged origin/master |
    grep --color=never remotes |
    grep -v HEAD |
    grep -v master |
    sed "s:remotes/origin/::g" |
    xargs -L 1 git push origin --delete
}
